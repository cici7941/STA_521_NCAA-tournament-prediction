---
title: "Project Work"
author: "SakaiAtMidnight"
date: "November 4, 2012"
output: pdf_document
---

We load the data:
```{r}
library(glmnet)
library(stringr)
library(plyr)
teams = read.csv("teams.csv")
seasons = read.csv("seasons.csv")
compactR = read.csv("regular_season_compact_results.csv")
#detailedR
compactT = read.csv("tourney_compact_results.csv")
detailedT = read.csv("tourney_detailed_results.csv")
detailedR = read.csv("regular_season_detailed_results.csv")
```

Including Seeds:
```{r}
seeds = read.csv("tourney_seeds.csv")
seeds2014 = seeds[which(seeds$season == 2014),]
tourney2014D = cbind(cbind(tourney2014D, rep(0, dim(tourney2014D)[1])),
                     rep(0, dim(tourney2014D)[1]))
colnames(tourney2014D)[35:36] = c("wSeed", "lSeed")
tourney2014D = tourney2014D[, c(1:2, 35, 3:4, 36, 5:34)]
for(i in 1:dim(tourney2014D)[1]){
  tourney2014D[i, "wSeed"] = as.character(seeds2014[which(seeds2014$team == tourney2014D$wteam[i]),"seed"])
  tourney2014D[i, "lSeed"] = as.character(seeds2014[which(seeds2014$team == tourney2014D$lteam[i]),"seed"])
}
```

Subsetting Tournament into Rounds:
```{r}
firstFour = tourney2014D[1:4,]
firstFourWinners = firstFour[,c("wSeed", "wteam")]

firstRound = tourney2014D[5:36,]
firstRoundWinners = firstRound[,c("wSeed", "wteam")]

secondRound = tourney2014D[37:52,]
secondRoundWinners = secondRound[,c("wSeed", "wteam")]

sweetSixteen = tourney2014D[53:60,]
sweetSixteenWinners = sweetSixteen[,c("wSeed", "wteam")]

eliteEight = tourney2014D[61:64,]
eliteEightWinners = eliteEight[,c("wSeed", "wteam")]

finalFour = tourney2014D[65:67,]
finalFourWinners = finalFour[,c("wSeed", "wteam")]
```

Subset 2012 info:
```{r}
#select 2012 season data
regSeason2012 = compactR[which(compactR$season == 2012),]
tourney2012 = compactT[which(compactT$season == 2012),]
regSeason2012D = detailedR[which(detailedR$season == 2012),]
tourney2014D = detailedT[which(detailedT$season == 2014),]


ChangeName <- function(df){
  names(df) <- str_replace_all(names(df), '^w', 'a.')
  names(df) <- str_replace_all(names(df), '^l', 'b.')
  return(df)
}

regSeason2012D <- ChangeName(regSeason2012D)

exchange <- function(data){
  result <- 0
  #data <- cbind(data, result)
  for(i in 1: nrow(data)){
    if (data$a.team[i] > data$b.team[i]){
      result[i] <- 0
      temp <- data$a.team[i]
      data$a.team[i] <- data$b.team[i]
      data$b.team[i] <- temp
      temp.vec <- data[i, 9:21]
      data[i, 9:21] <- data[i, 22:34]
      data[i, 22:34] <- temp.vec
    }
    else{
      result[i] <-1
    }
  }
  return(cbind(data, result))
}

datanew <- exchange(regSeason2012D)

library(stringr)


average <- function(data, index1, index2){
  data$season <- NULL
  data$daynum <- NULL
  data$a.loc <- NULL
  team.a <- str_detect(names(data),'^a') | str_detect(names(data),'numot')
  team.b <- str_detect(names(data),'^b') | str_detect(names(data),'numot')
  
  index1.a <- data[str_detect(data$a.team, index1), team.a]
  index1.b <- data[str_detect(data$b.team, index1), team.b]
  
  index1.mean <- (apply(index1.a,2,sum)+apply(index1.b,2,sum))/(nrow(index1.a)+nrow(index1.b))
  index1.mean <- index1.mean[-1]
  index2.a <- data[str_detect(data$a.team, index2), team.a]
  index2.b <- data[str_detect(data$a.team, index2), team.b]
  index2.mean <- (apply(index2.a,2,sum)+apply(index2.b,2,sum))/(nrow(index2.a)+nrow(index2.b))
  index2.mean <- index2.mean[-1]
  
  data$a.team <- NULL
  data$b.team <- NULL

  output <- c(index1.mean[1],index2.mean[1],mean(index1.mean[2],index1.mean[2]), index1.mean[-(1:2)],index2.mean[-(1:2)])
  
  
  names(output) <- names(data)
  return(as.matrix(output))
}

names(datanew)

#delete columns
datanew = datanew[, -c(1, 2, 3, 5, 7)]
#normalize data 
datanewS = as.data.frame(scale(datanew))
datanewS = datanewS[, -30]
#add the response column (binary number)
datanewS = cbind(datanewS, datanew$result)

datanewS = as.matrix(datanewS)

# LASSO
lm1 = cv.glmnet(datanewS[,1:29], datanewS[,30], standardize=FALSE, 
                               family = "binomial",alpha = 1) 

outcome1 <- rep(NA,nrow(tourney2012))
for (i in 1:nrow(tourney2012)){
  game <-average(regSeason2012D,as.character(tourney2012[i,'wteam']),as.character(tourney2012[i,'lteam']))
  outcome1[i] <- predict(lm1,t(game),type='response')
}
sum(outcome1 >=0.5)/67

# ELASTIC
lm2 = cv.glmnet(datanewS[,1:29], datanewS[,30], standardize=FALSE, 
                family = "binomial",alpha = 0.5) 

outcome2 <- rep(NA,nrow(tourney2012))
for (i in 1:nrow(tourney2012)){
  game <-average(regSeason2012D,as.character(tourney2012[i,'wteam']),as.character(tourney2012[i,'lteam']))
  outcome2[i] <- predict(lm2,t(game),type='response')
}
sum(outcome2 >=0.5)/67

# RIDGE
lm3 = cv.glmnet(datanewS[,1:29], datanewS[,30], standardize=FALSE, 
                family = "binomial",alpha = 0) 
outcome3 <- rep(NA,nrow(tourney2012))
for (i in 1:nrow(tourney2012)){
  game <-average(regSeason2012D,as.character(tourney2012[i,'wteam']),as.character(tourney2012[i,'lteam']))
  outcome3[i] <- predict(lm3,t(game),type='response')
}
sum(outcome3 >=0.5)/67




```

